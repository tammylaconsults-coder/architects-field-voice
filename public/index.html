<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unified Field Voice</title>
</head>
<body>
  <h1>Unified Field Voice</h1>

  <!-- Text input -->
  <input id="userInput" type="text" placeholder="Speak or type to the Unified Field..." />
  <button id="sendBtn">Send</button>
  <button id="micBtn">ðŸŽ¤ Start Mic</button>

  <div id="chat"></div>

  <script>
    const chatDiv = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");

    // --- SEND TEXT TO SERVER ---
    async function sendMessage(text) {
      appendMessage("You", text);
      input.value = "";

      const res = await fetch("/message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();

      appendMessage("Unified Field", data.reply);

      // Play voice
      playVoice(data.reply);
    }

    function appendMessage(sender, text) {
      const msg = document.createElement("p");
      msg.textContent = `${sender}: ${text}`;
      chatDiv.appendChild(msg);
    }

    // --- TEXT SEND BUTTON ---
    sendBtn.onclick = () => {
      if (input.value.trim() !== "") sendMessage(input.value.trim());
    };

    // --- MICROPHONE INPUT (Speech-to-Text) ---
    let recognizing = false;
    let recognition;
    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error", event);
      };

      recognition.onend = () => {
        recognizing = false;
        micBtn.textContent = "ðŸŽ¤ Start Mic";
      };
    }

    micBtn.onclick = () => {
      if (!recognizing) {
        recognition.start();
        recognizing = true;
        micBtn.textContent = "ðŸ›‘ Stop Mic";
      } else {
        recognition.stop();
      }
    };

    // --- PLAY VOICE (Unified Field TTS) ---
    async function playVoice(text) {
      const res = await fetch("/speak", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const audioBlob = await res.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      audio.play();
    }
  </script>
</body>
</html>
