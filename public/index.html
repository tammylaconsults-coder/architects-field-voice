<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Architects Field-Voice</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; background: #f4f4f9; }
    h1 { color: #333; }
    select, button { margin: 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    audio { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Architects Field-Voice</h1>
  <p>Select your microphone and then click "Connect"</p>

  <!-- Microphone dropdown -->
  <label for="micSelect">Microphone:</label>
  <select id="micSelect"></select>
  <br />

  <button id="connectBtn">Connect</button>

  <audio id="remoteAudio" autoplay></audio>

  <script>
    let pc;
    let ws;

    // List available microphones
    async function listMicrophones() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const micSelect = document.getElementById("micSelect");
      devices.forEach(device => {
        if (device.kind === "audioinput") {
          let option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Microphone ${micSelect.length + 1}`;
          micSelect.appendChild(option);
        }
      });
    }

    // Get stream from selected microphone
    async function getSelectedMicrophoneStream() {
      const deviceId = document.getElementById("micSelect").value;
      return await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: deviceId ? { exact: deviceId } : undefined }
      });
    }

    document.getElementById("connectBtn").onclick = async () => {
      ws = new WebSocket("wss://" + window.location.host + "/ws");
      pc = new RTCPeerConnection();

      // Play remote audio
      const remoteAudio = document.getElementById("remoteAudio");
      pc.ontrack = (event) => {
        remoteAudio.srcObject = event.streams[0];
      };

      // Add selected mic stream
      const localStream = await getSelectedMicrophoneStream();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // WebRTC signaling
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp }));
      };

      ws.onmessage = async (event) => {
        const message = JSON.parse(event.data);
        if (message.type === "answer") {
          await pc.setRemoteDescription({ type: "answer", sdp: message.sdp });
        }
      };
    };

    // Populate microphone list on load
    listMicrophones();
  </script>
</body>
</html>
