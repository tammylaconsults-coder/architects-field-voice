<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Architects Field-Voice</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 2rem;
  margin: 0;
}
button {
  padding: 12px 20px;
  margin: 10px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #444;
  color: #fff;
}
button:hover { background: #666; }
#log { margin-top: 1rem; font-size: 0.9rem; color: #aaa; white-space: pre-wrap; max-height: 300px; overflow-y: auto; width: 100%; }
</style>
</head>
<body>
<h1>Architects Field-Voice</h1>
<input id="nameInput" type="text" placeholder="Enter your name" />
<div>
  <button id="connectBtn">Connect</button>
  <button id="muteBtn" disabled>Mute</button>
</div>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const log = (msg) => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };

let ws, dc, localStream;
let muted = false;

// Helper: send participant message to AI
function sendParticipantMessage(name, text) {
  if (!dc || dc.readyState !== "open") return;
  dc.send(JSON.stringify({
    type: "response.create",
    response: {
      instructions: `${name} says: "${text}". Reflect back to the group in your ceremonial voice.`,
      voice: "marin"
    }
  }));
}

document.getElementById("connectBtn").onclick = async () => {
  const name = document.getElementById("nameInput").value.trim() || "Participant";

  try {
    log("Requesting microphoneâ€¦");
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // WebSocket connection to Render
    ws = new WebSocket(window.location.origin.replace(/^http/, "ws"));

    ws.onopen = () => log("Connected to server");
    ws.onmessage = (msg) => log("Server message: " + msg.data);

    // Create RTCPeerConnection
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    // Play remote AI audio
    const remoteAudio = new Audio();
    rem
