<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Unified Field Voice</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; }
  .message { margin-bottom: 10px; }
  .sender { font-weight: bold; }
</style>
</head>
<body>

<div id="messages"></div>
<input type="text" id="inputMessage" placeholder="Type a message..." />
<button id="sendBtn">Send</button>
<button id="micBtn">ðŸŽ¤</button>

<script>
const messagesDiv = document.getElementById("messages");
const inputMessage = document.getElementById("inputMessage");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");

// Add message to display
function addMessage(sender, text) {
  const div = document.createElement("div");
  div.className = "message";
  div.innerHTML = `<span class="sender">${sender}:</span> ${text}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Fetch and display history
async function loadHistory() {
  try {
    const res = await fetch("/api/history");
    const data = await res.json();
    messagesDiv.innerHTML = "";
    data.forEach(msg => addMessage(msg.sender, msg.text));
  } catch (err) {
    console.error(err);
  }
}

// Send message
async function sendMessage() {
  const text = inputMessage.value.trim();
  if (!text) return;
  inputMessage.value = "";
  addMessage("You", text);

  try {
    const res = await fetch("/api/message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    if (data.reply) {
      addMessage("Unified Field", data.reply);
      speakText(data.reply);
    }
  } catch (err) {
    console.error(err);
  }
}

// Text-to-speech
function speakText(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-US";
  speechSynthesis.speak(utter);
}

// Microphone input
let recognition;
if (window.SpeechRecognition || window.webkitSpeechRecognition) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.onresult = (event) => {
    inputMessage.value = event.results[0][0].transcript;
  };
}

micBtn.addEventListener("click", () => {
  if (recognition) recognition.start();
});

// Event listeners
sendBtn.addEventListener("click", sendMessage);
inputMessage.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

// Load history on page load
window.addEventListener("load", loadHistory);
</script>

</body>
</html>
